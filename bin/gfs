#!/usr/bin/env node
'use strict'
var fs = require('fs')
var path = require('path')
var chalk = require('chalk')
var inquirer = require('inquirer')
var meow = require('meow')
var list = require('cli-list')
var pkg = require('../package.json')
var Router = require('../src/router')
var gens = list(process.argv.slice(2))
var checkEnv = require('../src/check-env')
var minicli = null
var cli = gens.map(function (gen) {
    minicli = meow(
'Usage: gfs COMMAND [options]\n'+
'  $ gfs add --template react --type web --name question-detail\n'+
'  $ gfs rm --template react --type component --name question-detail\n'+
'Options\n'+
'  --template  project template, default is [react]\n'+
'  --type      module type [web|component]\n'+
'  --name      module name\n'+
'Examples\n'+
'  $ gfs add --template react --type web --name question-detail\n'+
'  $ gfs add --template react --type component --name ask\n'+
'  $ gfs rm --template react --type component --name ask\n'+
'  $ gfs rm --template react --type web --name question-detail\n', { pkg: pkg, argv: gen });
    var opts = minicli.flags;
    var args = minicli.input;
    // add un-camelized options too, for legacy
    // TODO: remove some time in the future when generators have upgraded
    Object.keys(opts).forEach(function (key) {
        var legacyKey = key.replace(/[A-Z]/g, function (m) {
            return '-' + m.toLowerCase();
        });
        opts[legacyKey] = opts[key];
    });

    return { opts: opts, args: args };
});
var firstCmd = cli[0] || { opts: {}, args: {} };
var cmd = firstCmd.args[0];
var router = new Router();

console.log(chalk.bold.cyan('Welcome to use GFS-cli!'));
// register route
router.registerRoute('add', require('../src/add'));
router.registerRoute('dev', require('../src/commands/dev'));
router.registerRoute('help', require('../src/commands/help'));
router.registerRoute('init', require('../src/commands/init'));
router.registerRoute('rm', require('../src/remove'));
router.registerRoute('serve', require('../src/commands/serve'));
router.registerRoute('alias', require('../src/commands/alias'));
process.once('exit', function(code){
    console.log(chalk.cyan('Action was done! Bye~'))
});
try {
    if(!cmd){
        minicli.showHelp()
        return
    }
    // package.json scripts alias
    var scripts = checkEnv.package().scripts || {}
    if(Object.keys(scripts).indexOf(cmd) != -1){
        router.navigate('alias', firstCmd)
        return
    }
    // valid cmd
    // first check `--template`
    if(!firstCmd.opts.template){
        inquirer.prompt([{
            name: 'confirmUseDefaultTemplate',
            type: 'confirm',
            message: chalk.yellow(cmd+' command --template option is dismiss, it will be use default config [react]')
        }], function (answers) {
            // Use user feedback for... whatever!!
            if(answers.confirmUseDefaultTemplate === true){
                // TODO add, rm, update should check `process.cwd()` is project root and directory structure is valid
                if(checkEnv.validCmd(firstCmd)) {
                    // async not catch error properly must add one!
                    try {
                        router.navigate(cmd, firstCmd)
                    }catch (e) {
                        console.log(chalk.bold.red('command not found!'))
                        router.navigate('help', router);
                    }

                }
            }
        });
    }else{
        if(checkEnv.validCmd(firstCmd)) {
            router.navigate(cmd, firstCmd)
        }
    }
}catch (e) {
    console.log(chalk.bold.red('command not found!'))
    router.navigate('help', router);
}